<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoChatLLM - å¤šæ¨¡æ…‹å‰µä½œåŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --dark-bg: #1e1e2e;
            --card-bg: #27293d;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: none;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border: none;
        }

        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .card-body {
            padding: 30px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .result-image {
            width: 100%;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 400px;
            object-fit: contain;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .feature-tabs {
            margin-bottom: 20px;
        }

        .nav-pills .nav-link {
            color: white;
            border-radius: 25px;
            margin-right: 10px;
            padding: 10px 25px;
            transition: all 0.3s;
        }

        .nav-pills .nav-link.active {
            background: white;
            color: var(--primary-color);
        }

        .alert {
            border-radius: 10px;
            border: none;
            margin-top: 15px;
        }

        .video-player {
            width: 100%;
            border-radius: 10px;
            margin-top: 15px;
            max-height: 400px;
        }

        .generation-time {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .icon-feature {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .feature-description {
            color: #6c757d;
            margin-bottom: 20px;
        }

        #historyContainer {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* æ™ºèƒ½å°è©±åŠ©æ‰‹æ¨£å¼ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
            min-height: 500px;
            max-height: 80vh;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            scroll-behavior: smooth;
        }

        /* ç”Ÿæˆçš„åœ–ç‰‡å€åŸŸå„ªåŒ– */
        .result-preview {
            margin-top: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }

        .batch-item {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            background: #f9f9f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .batch-header {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .batch-header h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .batch-prompt {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .batch-item img {
            margin-top: 0;
            border-radius: 0;
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
        }

        .result-preview img,
        .result-preview video {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
            object-fit: contain;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .message-header i {
            margin-right: 5px;
        }

        .message-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .file-preview {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æ‰¹é‡ç”Ÿæˆæ¨£å¼ - å·²åœ¨ä¸Šé¢çµ±ä¸€è™•ç† */

        .chat-input-area {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .file-upload-zone {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-zone:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .file-upload-zone.dragover {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .uploaded-file-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }

        .uploaded-file-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .uploaded-file-item .remove-file {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-input-box {
            display: flex;
            gap: 10px;
        }

        .chat-input-box textarea {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            resize: none;
            font-size: 1rem;
        }

        .chat-input-box textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 0 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .task-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 5px;
            font-weight: 500;
        }

        .task-badge.text-to-image { background: #e3f2fd; color: #1976d2; }
        .task-badge.image-to-image { background: #f3e5f5; color: #7b1fa2; }
        .task-badge.video-gen { background: #e8f5e9; color: #388e3c; }
        .task-badge.batch_image_generation { background: #fff3e0; color: #f57c00; }

        /* ============ éŸ¿æ‡‰å¼è¨­è¨ˆ ============ */
        
        /* å¹³æ¿è¨­å‚™ (768px - 1024px) */
        @media (max-width: 1024px) {
            .main-container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .chat-container {
                height: 60vh;
                min-height: 400px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .batch-item img {
                max-height: 300px;
            }
            
            .feature-tabs {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-pills .nav-link {
                margin-bottom: 5px;
                font-size: 0.9rem;
            }
        }
        
        /* æ‰‹æ©Ÿè¨­å‚™ (768pxä»¥ä¸‹) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .chat-container {
                height: calc(100vh - 200px);
                min-height: 350px;
            }
            
            .chat-messages {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .message-content {
                max-width: 95%;
                padding: 12px 16px;
                font-size: 0.95rem;
            }
            
            .message-header {
                font-size: 0.8rem;
            }
            
            .chat-input-area {
                padding: 12px;
            }
            
            .file-upload-zone {
                padding: 15px;
            }
            
            .file-upload-zone p {
                font-size: 0.9rem;
            }
            
            .uploaded-file-item {
                width: 60px;
                height: 60px;
            }
            
            .file-preview {
                width: 60px;
                height: 60px;
            }
            
            .result-preview {
                max-height: 400px;
                padding: 8px;
            }
            
            .batch-header {
                padding: 12px;
            }
            
            .batch-header h4 {
                font-size: 14px;
            }
            
            .batch-prompt {
                font-size: 13px;
            }
            
            .batch-item img {
                max-height: 250px;
            }
            
            .result-image {
                max-height: 250px;
            }
            
            .video-player {
                max-height: 250px;
            }
            
            /* å°èˆªæ¨™ç±¤æ‰‹æ©Ÿå„ªåŒ– */
            .feature-tabs {
                margin-bottom: 15px;
            }
            
            .nav-pills .nav-link {
                padding: 8px 15px;
                margin-right: 5px;
                margin-bottom: 5px;
                font-size: 0.85rem;
            }
            
            .nav-pills .nav-link i {
                margin-right: 5px;
            }
            
            /* æŒ‰éˆ•æ‰‹æ©Ÿå„ªåŒ– */
            .btn-primary {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .send-btn {
                padding: 0 15px;
            }
            
            .btn-group .btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            /* è¡¨å–®æ‰‹æ©Ÿå„ªåŒ– */
            .form-control {
                font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
            }
            
            textarea.form-control {
                min-height: 80px;
            }
            
            /* æ¨™ç±¤æ‰‹æ©Ÿå„ªåŒ– */
            .task-badge {
                font-size: 0.75rem;
                padding: 3px 8px;
            }
        }
        
        /* å°å±æ‰‹æ©Ÿ (480pxä»¥ä¸‹) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .card-body {
                padding: 12px;
            }
            
            .chat-container {
                height: calc(100vh - 180px);
                min-height: 300px;
            }
            
            .chat-messages {
                padding: 10px;
            }
            
            .message-content {
                max-width: 100%;
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .file-upload-zone {
                padding: 12px;
            }
            
            .file-upload-zone i {
                font-size: 1.5rem !important;
            }
            
            .file-upload-zone p {
                font-size: 0.85rem;
            }
            
            .uploaded-file-item {
                width: 50px;
                height: 50px;
            }
            
            .file-preview {
                width: 50px;
                height: 50px;
            }
            
            .batch-item {
                margin-bottom: 15px;
            }
            
            .batch-header {
                padding: 10px;
            }
            
            .batch-header h4 {
                font-size: 13px;
            }
            
            .batch-prompt {
                font-size: 12px;
            }
            
            .batch-item img {
                max-height: 200px;
            }
            
            .result-image {
                max-height: 200px;
            }
            
            .video-player {
                max-height: 200px;
            }
            
            .result-preview {
                max-height: 300px;
                padding: 5px;
            }
            
            /* å°èˆªæ¨™ç±¤è¶…å°å±å„ªåŒ– */
            .nav-pills .nav-link {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            /* æŒ‰éˆ•è¶…å°å±å„ªåŒ– */
            .btn-primary {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            .send-btn {
                padding: 0 12px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
                width: 100%;
            }
        }
        
        /* è§¸æ‘¸è¨­å‚™å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover {
                transform: none;
                box-shadow: none;
            }
            
            .nav-pills .nav-link:hover {
                background-color: rgba(255,255,255,0.1);
            }
            
            .file-upload-zone:hover {
                border-color: #ddd;
                background: white;
            }
        }
        
        /* é«˜åˆ†è¾¨ç‡å±å¹•å„ªåŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .result-image,
            .video-player {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }
        
        /* æ·±è‰²æ¨¡å¼æ”¯æŒï¼ˆå¯é¸ï¼‰ */
        @media (prefers-color-scheme: dark) {
            .chat-messages {
                background: #2d3748;
                color: #e2e8f0;
            }
            
            .message.assistant .message-content {
                background: #4a5568;
                color: #e2e8f0;
            }
            
            .batch-item {
                background: #4a5568;
                border-color: #718096;
            }
            
            .batch-header {
                background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-magic"></i> VideoChatLLM</h1>
            <p>æ™ºèƒ½å¤šæ¨¡æ…‹å‰µä½œåŠ©æ‰‹ - æ–‡ç”Ÿåœ– Â· åœ–ç”Ÿåœ– Â· Veo è¦–é »ç”Ÿæˆ</p>
        </div>

        <!-- Feature Tabs -->
        <ul class="nav nav-pills feature-tabs justify-content-center" id="featureTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="pill" href="#textToImage">
                    <i class="bi bi-image"></i> æ–‡ç”Ÿåœ–
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="pill" href="#imageToImage">
                    <i class="bi bi-arrow-left-right"></i> åœ–ç”Ÿåœ–
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="pill" href="#textToVideo">
                    <i class="bi bi-camera-video"></i> Veo è¦–é »
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="pill" href="#chat">
                    <i class="bi bi-chat-dots"></i> å°è©±åŠ©æ‰‹
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- æ–‡ç”Ÿåœ– -->
            <div id="textToImage" class="tab-pane fade show active">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-image"></i> æ–‡æœ¬ç”Ÿæˆåœ–ç‰‡</h5>
                    </div>
                    <div class="card-body">
                        <div class="icon-feature text-center">
                            <i class="bi bi-magic"></i>
                        </div>
                        <p class="feature-description text-center">
                            è¼¸å…¥æ–‡å­—æè¿°ï¼ŒAI å°‡ç‚ºæ‚¨ç”Ÿæˆç²¾ç¾çš„åœ–ç‰‡
                        </p>
                        <div class="mb-3">
                            <label class="form-label">è¼¸å…¥æç¤ºè©</label>
                            <textarea class="form-control" id="imagePrompt" rows="3" 
                                placeholder="ä¾‹å¦‚ï¼šä¸€éš»å¯æ„›çš„å°è²“ååœ¨çª—å°ä¸Šï¼Œé™½å…‰ç‘åœ¨æ¯›èŒ¸èŒ¸çš„èº«ä¸Š"></textarea>
                        </div>
                        <button class="btn btn-primary w-100" onclick="generateImage()">
                            <i class="bi bi-sparkles"></i> ç”Ÿæˆåœ–ç‰‡
                        </button>
                        
                        <div class="loading" id="imageLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ç”Ÿæˆä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨ç”Ÿæˆåœ–ç‰‡ï¼Œè«‹ç¨å€™...</p>
                        </div>

                        <div id="imageResult"></div>
                    </div>
                </div>
            </div>

            <!-- åœ–ç”Ÿåœ– -->
            <div id="imageToImage" class="tab-pane fade">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-arrow-left-right"></i> åœ–ç‰‡é¢¨æ ¼è½‰æ›</h5>
                    </div>
                    <div class="card-body">
                        <div class="icon-feature text-center">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                        <p class="feature-description text-center">
                            ä¸Šå‚³åœ–ç‰‡ä¸¦è¼¸å…¥è½‰æ›æè¿°ï¼ŒAI å°‡ç‚ºæ‚¨å‰µå»ºæ–°çš„é¢¨æ ¼
                        </p>
                        <div class="mb-3">
                            <label class="form-label">ä¸Šå‚³åœ–ç‰‡ï¼ˆå¯é¸å¤šå¼µï¼‰</label>
                            <input type="file" class="form-control" id="imageUpload" accept="image/*" multiple>
                            <small class="text-muted">å¯ä»¥åŒæ™‚é¸æ“‡å¤šå¼µåœ–ç‰‡ä½œç‚ºåƒè€ƒ</small>
                            <div id="imagePreview" class="mt-3"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è½‰æ›æè¿°</label>
                            <textarea class="form-control" id="transformPrompt" rows="3" 
                                placeholder="ä¾‹å¦‚ï¼šå°‡åœ–ç‰‡è½‰æ›ç‚ºæ²¹ç•«é¢¨æ ¼"></textarea>
                        </div>
                        <button class="btn btn-primary w-100" onclick="transformImage()">
                            <i class="bi bi-arrow-repeat"></i> è½‰æ›åœ–ç‰‡
                        </button>

                        <div class="loading" id="transformLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">è½‰æ›ä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨è½‰æ›åœ–ç‰‡ï¼Œè«‹ç¨å€™...</p>
                        </div>

                        <div id="transformResult"></div>
                    </div>
                </div>
            </div>

            <!-- Veo è¦–é »ç”Ÿæˆ -->
            <div id="textToVideo" class="tab-pane fade">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-camera-video"></i> Veo è¦–é »ç”Ÿæˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="icon-feature text-center">
                            <i class="bi bi-film"></i>
                        </div>
                        <p class="feature-description text-center">
                            ä½¿ç”¨ Google Veo3.1 æ ¹æ“šæ–‡å­—æè¿°æˆ–åœ–ç‰‡ç”Ÿæˆé«˜è³ªé‡è¦–é »
                        </p>
                        
                        <!-- æ¨¡å¼é¸æ“‡ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">é¸æ“‡ç”Ÿæˆæ¨¡å¼</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="videoMode" id="textToVideoMode" value="text_to_video" checked>
                                <label class="btn btn-outline-primary" for="textToVideoMode">
                                    <i class="bi bi-text-paragraph"></i> æ–‡ç”Ÿè¦–é »
                                </label>
                                
                                <input type="radio" class="btn-check" name="videoMode" id="imageToVideoMode" value="image_to_video">
                                <label class="btn btn-outline-primary" for="imageToVideoMode">
                                    <i class="bi bi-image"></i> åœ–ç”Ÿè¦–é »
                                </label>
                                
                                <input type="radio" class="btn-check" name="videoMode" id="firstToLastMode" value="first_to_last">
                                <label class="btn btn-outline-primary" for="firstToLastMode">
                                    <i class="bi bi-arrows-expand"></i> é¦–å°¾å¹€æ’å€¼
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2" id="modeDescription">
                                ç´”æ–‡å­—æè¿°ç”Ÿæˆè¦–é »
                            </small>
                        </div>

                        <!-- æ–‡ç”Ÿè¦–é »è¼¸å…¥ -->
                        <div id="textToVideoInputs" class="mode-inputs">
                            <!-- ç„¡é¡å¤–è¼¸å…¥ï¼Œåªéœ€è¦æç¤ºè© -->
                        </div>

                        <!-- åœ–ç”Ÿè¦–é »è¼¸å…¥ -->
                        <div id="imageToVideoInputs" class="mode-inputs" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">ä¸Šå‚³åƒè€ƒåœ–ç‰‡</label>
                                <input type="file" class="form-control" id="videoImageUpload" accept="image/*">
                                <small class="text-muted">ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ä½œç‚ºè¦–é »åƒè€ƒ</small>
                                <div id="videoImagePreview" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- é¦–å°¾å¹€æ’å€¼è¼¸å…¥ -->
                        <div id="firstToLastInputs" class="mode-inputs" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">é¦–å¹€åœ–ç‰‡</label>
                                    <input type="file" class="form-control" id="firstFrameUpload" accept="image/*">
                                    <small class="text-muted">è¦–é »çš„ç¬¬ä¸€å¹€</small>
                                    <div id="firstFramePreview" class="mt-2"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å°¾å¹€åœ–ç‰‡</label>
                                    <input type="file" class="form-control" id="lastFrameUpload" accept="image/*">
                                    <small class="text-muted">è¦–é »çš„æœ€å¾Œä¸€å¹€</small>
                                    <div id="lastFramePreview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- é€šç”¨è¼¸å…¥ -->
                        <div class="mb-3">
                            <label class="form-label">è¦–é »æè¿°ï¼ˆè‹±æ–‡ï¼‰</label>
                            <textarea class="form-control" id="videoPrompt" rows="3" 
                                placeholder="ä¾‹å¦‚ï¼šA majestic deer walking gracefully through a misty forest in the morning light"></textarea>
                            <small class="text-muted" id="promptHint">æç¤ºè©æè¿°è¦–é »çš„æ•´é«”é¢¨æ ¼å’Œå‹•ä½œ</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è¦–é »æ™‚é•·ï¼ˆç§’ï¼‰</label>
                            <input type="number" class="form-control" id="videoDuration" value="5" min="5" max="30">
                        </div>
                        <button class="btn btn-primary w-100" onclick="generateVideo()">
                            <i class="bi bi-play-circle"></i> ç”Ÿæˆè¦–é »
                        </button>

                        <div class="loading" id="videoLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ç”Ÿæˆä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨ç”Ÿæˆè¦–é »ï¼Œå¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ï¼Œè«‹ç¨å€™...</p>
                            <small class="text-muted">è¦–é »ç”Ÿæˆé€šå¸¸éœ€è¦ 1-3 åˆ†é˜</small>
                        </div>

                        <div id="videoResult"></div>
                    </div>
                </div>
            </div>

            <!-- å°è©±åŠ©æ‰‹ -->
            <div id="chat" class="tab-pane fade">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-chat-dots"></i> AI æ™ºèƒ½å°è©±åŠ©æ‰‹</h5>
                        <small>æ”¯æŒè‡ªç„¶èªè¨€å°è©±ï¼Œè‡ªå‹•è­˜åˆ¥ä»»å‹™é¡å‹ï¼ˆæ–‡ç”Ÿåœ–/åœ–ç”Ÿåœ–/è¦–é »ç”Ÿæˆï¼‰</small>
                    </div>
                    <div class="card-body">
                        <!-- å°è©±å€åŸŸ -->
                        <div class="chat-container">
                            <div class="chat-messages" id="chatMessages">
                                <!-- æ­¡è¿æ¶ˆæ¯ -->
                                <div class="message assistant">
                                    <div class="message-content">
                                        <div class="message-header">
                                            <i class="bi bi-robot"></i> AI åŠ©æ‰‹
                                        </div>
                                        <p>æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½å¤šæ¨¡æ…‹å‰µä½œåŠ©æ‰‹ ğŸ¨</p>
                                        <p><strong>æˆ‘å¯ä»¥å¹«æ‚¨ï¼š</strong></p>
                                        <ul style="margin: 10px 0; padding-left: 20px;">
                                            <li>ğŸ“ æ–‡ç”Ÿåœ–ï¼šæè¿°æ‚¨æƒ³è¦çš„åœ–ç‰‡</li>
                                            <li>ğŸ–¼ï¸ åœ–ç”Ÿåœ–ï¼šä¸Šå‚³åœ–ç‰‡ä¸¦èªªæ˜è¦å¦‚ä½•ä¿®æ”¹</li>
                                            <li>ğŸ¬ åœ–ç”Ÿè¦–é »ï¼šä¸Šå‚³åœ–ç‰‡ç”Ÿæˆå‹•æ…‹è¦–é »</li>
                                            <li>â†”ï¸ é¦–å°¾å¹€æ’å€¼ï¼šä¸Šå‚³é¦–å°¾å…©å¹€ç”Ÿæˆå®Œæ•´è¦–é »</li>
                                            <li>ğŸ“¹ æ–‡ç”Ÿè¦–é »ï¼šç´”æ–‡å­—æè¿°ç”Ÿæˆè¦–é »</li>
                                        </ul>
                                        <p><small>ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥ç›´æ¥ç”¨è‡ªç„¶èªè¨€å‘Šè¨´æˆ‘éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥æ‹–æ‹½æˆ–ä¸Šå‚³æ–‡ä»¶ï¼ˆæœ€å¤š10å€‹ï¼‰</small></p>
                                    </div>
                                </div>
                            </div>

                            <!-- è¼¸å…¥å€åŸŸ -->
                            <div class="chat-input-area">
                                <!-- æ–‡ä»¶ä¸Šå‚³å€ -->
                                <div class="file-upload-zone" id="fileUploadZone">
                                    <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                                    <p class="mb-0 mt-2">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</p>
                                    <small class="text-muted">æ”¯æŒåœ–ç‰‡æ ¼å¼ï¼Œæœ€å¤š10å€‹æ–‡ä»¶</small>
                                    <input type="file" id="chatFileInput" multiple accept="image/*" style="display: none;">
                                </div>

                                <!-- å·²ä¸Šå‚³æ–‡ä»¶é è¦½ -->
                                <div class="uploaded-files" id="uploadedFiles"></div>

                                <!-- è¼¸å…¥æ¡† -->
                                <div class="chat-input-box">
                                    <textarea 
                                        id="chatInput" 
                                        rows="3" 
                                        placeholder="è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šå¹«æˆ‘ç”Ÿæˆä¸€å¼µå¤•é™½ä¸‹çš„æµ·ç˜é¢¨æ™¯åœ–..."
                                    ></textarea>
                                    <button class="send-btn" id="sendBtn" onclick="sendChatMessage()">
                                        <i class="bi bi-send-fill"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ¨¡å¼åˆ‡æ›
        document.querySelectorAll('input[name="videoMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const mode = this.value;
                const modeDescription = document.getElementById('modeDescription');
                const promptHint = document.getElementById('promptHint');
                
                // éš±è—æ‰€æœ‰æ¨¡å¼è¼¸å…¥
                document.getElementById('textToVideoInputs').style.display = 'none';
                document.getElementById('imageToVideoInputs').style.display = 'none';
                document.getElementById('firstToLastInputs').style.display = 'none';
                
                // æ ¹æ“šæ¨¡å¼é¡¯ç¤ºå°æ‡‰è¼¸å…¥
                if (mode === 'text_to_video') {
                    document.getElementById('textToVideoInputs').style.display = 'block';
                    modeDescription.textContent = 'ç´”æ–‡å­—æè¿°ç”Ÿæˆè¦–é »';
                    promptHint.textContent = 'æç¤ºè©æè¿°è¦–é »çš„æ•´é«”é¢¨æ ¼å’Œå‹•ä½œ';
                } else if (mode === 'image_to_video') {
                    document.getElementById('imageToVideoInputs').style.display = 'block';
                    modeDescription.textContent = 'å¾å–®å¼µåœ–ç‰‡ç”Ÿæˆè¦–é »å‹•ç•«';
                    promptHint.textContent = 'æç¤ºè©æè¿°åœ–ç‰‡å¦‚ä½•å‹•èµ·ä¾†';
                } else if (mode === 'first_to_last') {
                    document.getElementById('firstToLastInputs').style.display = 'block';
                    modeDescription.textContent = 'ä¸Šå‚³é¦–å°¾å…©å¹€ï¼ŒAI è‡ªå‹•æ’å€¼ç”Ÿæˆä¸­é–“å¹€';
                    promptHint.textContent = 'æç¤ºè©æè¿°é¦–å°¾å¹€ä¹‹é–“çš„éæ¸¡æ•ˆæœï¼ˆå¯é¸ï¼‰';
                }
            });
        });

        // åœ–ç‰‡é è¦½ - å–®å¼µåœ–ç‰‡ï¼ˆåœ–ç”Ÿè¦–é »ï¼‰
        document.getElementById('videoImageUpload')?.addEventListener('change', function(e) {
            const preview = document.getElementById('videoImagePreview');
            preview.innerHTML = '';
            
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                    `;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // åœ–ç‰‡é è¦½ - é¦–å¹€
        document.getElementById('firstFrameUpload')?.addEventListener('change', function(e) {
            const preview = document.getElementById('firstFramePreview');
            preview.innerHTML = '';
            
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                    `;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // åœ–ç‰‡é è¦½ - å°¾å¹€
        document.getElementById('lastFrameUpload')?.addEventListener('change', function(e) {
            const preview = document.getElementById('lastFramePreview');
            preview.innerHTML = '';
            
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                    `;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // æ–‡ç”Ÿåœ–
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value;
            if (!prompt) {
                alert('è«‹è¼¸å…¥æç¤ºè©');
                return;
            }

            const loading = document.getElementById('imageLoading');
            const resultDiv = document.getElementById('imageResult');
            
            loading.classList.add('show');
            resultDiv.innerHTML = '';

            try {
                const response = await fetch('/api/generate_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> åœ–ç‰‡ç”ŸæˆæˆåŠŸï¼
                        </div>
                        <img src="${data.image}" class="result-image" alt="ç”Ÿæˆçš„åœ–ç‰‡">
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-outline-primary" onclick="window.open('${data.image}')">
                                <i class="bi bi-download"></i> ä¸‹è¼‰åœ–ç‰‡
                            </button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå¤±æ•—: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }

        // åœ–ç”Ÿåœ– - æ”¯æŒå¤šå¼µåœ–ç‰‡
        async function transformImage() {
            const prompt = document.getElementById('transformPrompt').value;
            const fileInput = document.getElementById('imageUpload');
            const files = fileInput.files;

            if (!prompt || files.length === 0) {
                alert('è«‹ä¸Šå‚³åœ–ç‰‡ä¸¦è¼¸å…¥è½‰æ›æè¿°');
                return;
            }

            const loading = document.getElementById('transformLoading');
            const resultDiv = document.getElementById('transformResult');
            
            loading.classList.add('show');
            resultDiv.innerHTML = '';

            // è®€å–æ‰€æœ‰åœ–ç‰‡
            const readAllImages = () => {
                return Promise.all(Array.from(files).map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                }));
            };

            try {
                const images = await readAllImages();
                
                const response = await fetch('/api/transform_image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt, images})
                });

                const data = await response.json();

                if (data.success) {
                    let imagesHtml = data.images ? 
                        data.images.map(img => `<img src="${img}" class="result-image mb-3" alt="è½‰æ›å¾Œçš„åœ–ç‰‡" style="margin-bottom: 15px;">`).join('') :
                        `<img src="${data.image}" class="result-image" alt="è½‰æ›å¾Œçš„åœ–ç‰‡">`;
                    
                    let downloadBtns = data.images && data.images.length > 0 ? 
                        data.images.map((img, idx) => `<button class="btn btn-outline-primary mb-2" onclick="window.open('${img}')"><i class="bi bi-download"></i> ä¸‹è¼‰åœ–ç‰‡ ${idx + 1}</button>`).join('') :
                        `<button class="btn btn-outline-primary" onclick="window.open('${data.image}')"><i class="bi bi-download"></i> ä¸‹è¼‰åœ–ç‰‡</button>`;

                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> åœ–ç‰‡è½‰æ›æˆåŠŸï¼${data.count ? 'ï¼ˆ' + data.count + ' å¼µï¼‰' : ''}
                        </div>
                        ${imagesHtml}
                        <div class="d-grid gap-2 mt-3">
                            ${downloadBtns}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">è½‰æ›å¤±æ•—: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }

        // é è¦½ä¸Šå‚³çš„åœ–ç‰‡
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            Array.from(this.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'd-inline-block me-2 mb-2';
                    imgContainer.innerHTML = `
                        <div style="position: relative; border: 2px solid #ddd; border-radius: 8px; padding: 5px;">
                            <img src="${e.target.result}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 5px;">
                            <span class="badge bg-primary position-absolute top-0 start-0 m-1">${index + 1}</span>
                        </div>
                    `;
                    preview.appendChild(imgContainer);
                };
                reader.readAsDataURL(file);
            });
        });

        // ç”Ÿæˆè¦–é »
        async function generateVideo() {
            const prompt = document.getElementById('videoPrompt').value;
            const duration = parseInt(document.getElementById('videoDuration').value);
            const mode = document.querySelector('input[name="videoMode"]:checked').value;

            // é©—è­‰è¼¸å…¥
            if (mode === 'text_to_video' && !prompt) {
                alert('è«‹è¼¸å…¥è¦–é »æè¿°');
                return;
            }

            if (mode === 'image_to_video') {
                const imageInput = document.getElementById('videoImageUpload');
                if (!imageInput.files || imageInput.files.length === 0) {
                    alert('è«‹ä¸Šå‚³åƒè€ƒåœ–ç‰‡');
                    return;
                }
                if (!prompt) {
                    alert('è«‹è¼¸å…¥è¦–é »æè¿°');
                    return;
                }
            }

            if (mode === 'first_to_last') {
                const firstFrameInput = document.getElementById('firstFrameUpload');
                const lastFrameInput = document.getElementById('lastFrameUpload');
                if (!firstFrameInput.files || firstFrameInput.files.length === 0 || 
                    !lastFrameInput.files || lastFrameInput.files.length === 0) {
                    alert('è«‹ä¸Šå‚³é¦–å¹€å’Œå°¾å¹€åœ–ç‰‡');
                    return;
                }
            }

            const loading = document.getElementById('videoLoading');
            const resultDiv = document.getElementById('videoResult');
            
            loading.classList.add('show');
            resultDiv.innerHTML = '';

            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('duration', duration);
            formData.append('mode', mode);

            // æ ¹æ“šæ¨¡å¼æ·»åŠ æ–‡ä»¶
            if (mode === 'image_to_video') {
                const imageInput = document.getElementById('videoImageUpload');
                formData.append('image', imageInput.files[0]);
            } else if (mode === 'first_to_last') {
                const firstFrameInput = document.getElementById('firstFrameUpload');
                const lastFrameInput = document.getElementById('lastFrameUpload');
                formData.append('first_frame', firstFrameInput.files[0]);
                formData.append('last_frame', lastFrameInput.files[0]);
            }

            try {
                const response = await fetch('/api/generate_video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> è¦–é »ç”ŸæˆæˆåŠŸï¼
                        </div>
                        <video controls class="video-player">
                            <source src="/api/download/${data.filename}" type="video/mp4">
                        </video>
                        <div class="generation-time">ç”Ÿæˆè€—æ™‚: ${data.generation_time.toFixed(2)} ç§’</div>
                        <div class="d-grid gap-2 mt-3">
                            <a href="/api/download/${data.filename}" class="btn btn-outline-primary" download>
                                <i class="bi bi-download"></i> ä¸‹è¼‰è¦–é »
                            </a>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå¤±æ•—: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }

        // ============ æ™ºèƒ½å°è©±åŠ©æ‰‹ ============
        let chatFiles = [];
        const MAX_FILES = 10;

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šå‚³
        const fileUploadZone = document.getElementById('fileUploadZone');
        const chatFileInput = document.getElementById('chatFileInput');
        const uploadedFilesDiv = document.getElementById('uploadedFiles');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // é»æ“Šä¸Šå‚³å€
        fileUploadZone.addEventListener('click', () => {
            chatFileInput.click();
        });

        // æ–‡ä»¶é¸æ“‡
        chatFileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files));
            e.target.value = ''; // æ¸…ç©ºinputä»¥å…è¨±é‡è¤‡é¸æ“‡
        });

        // æ‹–æ‹½ä¸Šå‚³
        fileUploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadZone.classList.add('dragover');
        });

        fileUploadZone.addEventListener('dragleave', () => {
            fileUploadZone.classList.remove('dragover');
        });

        fileUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            handleFiles(files);
        });

        // Enter ç™¼é€
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        // è™•ç†ä¸Šå‚³çš„æ–‡ä»¶
        function handleFiles(files) {
            if (chatFiles.length + files.length > MAX_FILES) {
                alert(`æœ€å¤šåªèƒ½ä¸Šå‚³ ${MAX_FILES} å€‹æ–‡ä»¶`);
                return;
            }

            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('åƒ…æ”¯æŒåœ–ç‰‡æ–‡ä»¶');
                    return;
                }
                chatFiles.push(file);
            });

            renderUploadedFiles();
        }

        // æ¸²æŸ“å·²ä¸Šå‚³æ–‡ä»¶
        function renderUploadedFiles() {
            uploadedFilesDiv.innerHTML = '';
            chatFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'uploaded-file-item';
                    fileItem.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <button class="remove-file" onclick="removeFile(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    uploadedFilesDiv.appendChild(fileItem);
                };
                reader.readAsDataURL(file);
            });
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(index) {
            chatFiles.splice(index, 1);
            renderUploadedFiles();
        }

        // ç™¼é€æ¶ˆæ¯
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            
            if (!message && chatFiles.length === 0) {
                alert('è«‹è¼¸å…¥æ¶ˆæ¯æˆ–ä¸Šå‚³æ–‡ä»¶');
                return;
            }

            // ç¦ç”¨è¼¸å…¥
            sendBtn.disabled = true;
            chatInput.disabled = true;

            // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage('user', message, chatFiles);

            // æ¸…ç©ºè¼¸å…¥
            const filesForRequest = [...chatFiles];
            chatInput.value = '';
            chatFiles = [];
            renderUploadedFiles();

            // é¡¯ç¤ºè¼¸å…¥ä¸­æŒ‡ç¤ºå™¨
            showTypingIndicator();

            try {
                // ç¬¬ä¸€æ­¥ï¼šåˆ†ææ„åœ–
                const intentResult = await analyzeIntent(message, filesForRequest);
                
                // ç¬¬äºŒæ­¥ï¼šåŸ·è¡Œä»»å‹™
                const executionResult = await executeTask(intentResult);
                
                // æ·»åŠ AIå›æ‡‰
                addMessage('assistant', executionResult.message, [], executionResult);

            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', `âŒ åŸ·è¡Œå¤±æ•—: ${error.message}`, []);
            } finally {
                hideTypingIndicator();
                sendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        // åˆ†ææ„åœ–
        async function analyzeIntent(message, files) {
            const formData = new FormData();
            formData.append('message', message);
            files.forEach(file => {
                formData.append('files', file);
            });

            const response = await fetch('/api/analyze_intent', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('æ„åœ–åˆ†æå¤±æ•—');
            }

            return await response.json();
        }

        // åŸ·è¡Œä»»å‹™
        async function executeTask(intentData) {
            const response = await fetch('/api/execute_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(intentData)
            });

            if (!response.ok) {
                throw new Error('ä»»å‹™åŸ·è¡Œå¤±æ•—');
            }

            return await response.json();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, text, files = [], result = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let filesHtml = '';
            if (files.length > 0) {
                filesHtml = '<div class="message-files">';
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const filePreview = document.createElement('div');
                        filePreview.className = 'file-preview';
                        filePreview.innerHTML = `<img src="${e.target.result}" alt="${file.name}">`;
                        messageDiv.querySelector('.message-files').appendChild(filePreview);
                    };
                    reader.readAsDataURL(file);
                });
                filesHtml += '</div>';
            }

            let resultHtml = '';
            if (result) {
                if (result.taskType) {
                    const taskLabels = {
                        'text_to_image': 'æ–‡ç”Ÿåœ–',
                        'image_to_image': 'åœ–ç”Ÿåœ–',
                        'image_to_video': 'åœ–ç”Ÿè¦–é »',
                        'text_to_video': 'æ–‡ç”Ÿè¦–é »',
                        'first_to_last_frame': 'é¦–å°¾å¹€æ’å€¼'
                    };
                    resultHtml += `<span class="task-badge ${result.taskType}">${taskLabels[result.taskType] || result.taskType}</span>`;
                }

                if (result.images) {
                    resultHtml += '<div class="result-preview">';
                    
                    // å¦‚æœæ˜¯æ‰¹é‡ç”Ÿæˆï¼Œé¡¯ç¤ºå ´æ™¯è©³ç´°ä¿¡æ¯
                    if (result.batch_details && result.batch_details.length > 0) {
                        result.batch_details.forEach((detail, index) => {
                            resultHtml += `
                                <div class="batch-item">
                                    <div class="batch-header">
                                        <h4>å ´æ™¯ ${detail.step}</h4>
                                        <p class="batch-prompt">${detail.prompt}</p>
                                    </div>
                                    <img src="${detail.image}" alt="Generated Scene ${detail.step}">
                                </div>
                            `;
                        });
                    } else {
                        // æ™®é€šåœ–ç‰‡é¡¯ç¤º
                        result.images.forEach(img => {
                            resultHtml += `<img src="${img}" alt="Generated Image">`;
                        });
                    }
                    
                    resultHtml += '</div>';
                }

                if (result.video) {
                    resultHtml += `
                        <div class="result-preview">
                            <video controls class="video-player">
                                <source src="${result.video}" type="video/mp4">
                            </video>
                        </div>
                    `;
                }
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <i class="bi bi-${role === 'user' ? 'person-fill' : 'robot'}"></i>
                        ${role === 'user' ? 'æ‚¨' : 'AI åŠ©æ‰‹'}
                    </div>
                    ${text ? `<p style="margin: 0;">${text}</p>` : ''}
                    ${filesHtml}
                    ${resultHtml}
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // é¡¯ç¤ºè¼¸å…¥ä¸­æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(indicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // éš±è—è¼¸å…¥ä¸­æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // å°è©±ï¼ˆä¿ç•™èˆŠç‰ˆå…¼å®¹æ€§ï¼‰
        async function sendChat() {
            return sendChatMessage();
        }
    </script>
</body>
</html>

